{"compress":true,"commitItems":[["8aa20b9f-4f49-4f74-b422-8d52047c6f10",1534424318613,"#1\\. 介绍\n\n这篇文章简单地介绍了python的paramiko模块的用法，paramiko实现了SSH协议，能够方便地与远程计算机交互。简单的说，就是你在terminal下执行的如下语句，现在可以通过python的paramiko实现了。\n\n```\n    # 执行shell语句\n    ssh -i ~/.ssh/id_rsa -p 1098  rds@12.164.145.21 -e 'ls -al'\n\n    # 拷贝数据到远程计算机\n    scp -i ~/.ssh/id_rsa -P 1098 -r data rds@12.164.145.21:~/data\n```\n\n这里不讨论shell与python实现的优缺点，如果你没有需求，也不会看到这篇博客了。我个人使用paramiko是为了使用python的多线程，并发地对多台远程计算机执行相同的操作。\n\n这篇博客虽然篇幅不大，但是，可能是目前网络上最好的中文入门教程了。那就开始吧！\n\n# 2\\. 安装\n\n安装非常简单，直接使用pip安装即可:\n\n```\nsudo pip instal paramiko\n```\n\n# 3\\. 建立SSH连接\n\n使用密码连接：\n\n```\nimport paramiko\nssh = paramiko.SSHClient()\n\n#这行代码的作用是允许连接不在know_hosts文件中的主机。\nssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())\nssh.connect(\"IP\",  port, \"username\", \"password\")\n```\n\n使用私钥连接：\n\n```\nssh = paramiko.SSHClient()\nssh.connect('10.120.48.109', port, '用户名',\nkey_filename='私钥')\n```\n\n连接以后可以执行shell命令：\n\n```\nIn [8]: ssh.exec_command('ls')\nOut[8]:\n(<paramiko.ChannelFile from <paramiko.Channel 1 (open) window=2097152 -> <paramiko.Transport at 0x377c690L (cipher aes128-ctr, 128 bits) (active; 2 open channel(s))>>>,\n <paramiko.ChannelFile from <paramiko.Channel 1 (open) window=2097152 -> <paramiko.Transport at 0x377c690L (cipher aes128-ctr, 128 bits) (active; 2 open channel(s))>>>,\n <paramiko.ChannelFile from <paramiko.Channel 1 (open) window=2097152 -> <paramiko.Transport at 0x377c690L (cipher aes128-ctr, 128 bits) (active; 2 open channel(s))>>>)\n```\n\n执行shell命令以后，并不会立即打印命令的执行结果，而是返回几个Channel, 只能像下面这样获取输出：\n\n```\nIn [9]: stdin, stdout, stderr = ssh.exec_command('ls')\n\nIn [10]: print stdout.readlines()\n['AgentBackkup_2015-06-11\\n', 'AgentBackup\\n', 'log\\n', 'mysql.sh\\n', 'rdsAgent\\n']\n```\n\n**注意：** 命令执行出错并不会抛出异常，所以，对于命令出错需要根据自己的需求进行相应的处理：\n\n```\nIn [54]: stdin, stdout, stderr = ssh.exec_command('cat file_not_found')\nIn [55]: print stdout.readlines()\n[]\n\nIn [56]: print stderr.readlines()\n[u'cat: file_not_found: No such file or directory\\n']\n\nIn [57]: stdin, stdout, stderr = ssh.exec_command('ls')\nIn [58]: print stderr.readlines()\n[]\n```\n\n**API文档:** [https://paramiko-docs.readthedocs.org/en/1.15/api/client.html](https://paramiko-docs.readthedocs.org/en/1.15/api/client.html)\n\n# 4\\. SCP vs SFTP\n\n通过paramiko还可以传输文件，这是我写这篇博客的主要原因。搜了很多博客，都没有说明白如何通过paramiko在计算机之间传输文件，通过阅读官方文档，发现有如下两种方式：\n\n```\nsftp = paramiko.SFTPClient.from_transport(ssh.get_transport())\nsftp = ssh.open_sftp()\n```\n\n即新建一个SFTPClient对象，该对象复用之前的SSH连接，因此，我们使用sftp传输文件时，不需要再次进行用户认证。\n\n*   文件上传\n\n    ```\n      In [59]: sftp.put('memory.py', 'memory.py')\n      Out[59]: <SFTPAttributes: [ size=288 uid=1000 gid=1000 mode=0100644 atime=1435391914 mtime=1435391914 ]>\n    ```\n\n*   文件下载\n\n    ```\n      In [60]: sftp.get('memory.py', 'backup.py')\n    ```\n\n*   执行命令\n\n    paramiko并没有提供一个叫做scp的子模块，如果我们希望在计算机之间传输数据，可以通过sftp(sftp实现了scp所有的功能，也就没有必再实现一个scp)传输文件，还可以通过sftp执行命令，如下所示：\n\n    ```\n      In [44]: sftp.listdir()\n      Out[44]:\n      ['.viminfo',\n      '.bash_logout',\n      '.bash_history',\n      'AgentBackkup_2015-06-10',\n      'AgentBackup',\n      'rdsAgent']\n\n      In [45]: sftp.rename('AgentBackkup_2015-06-10', 'AgentBackkup_2015-06-11')\n\n      In [46]: sftp.listdir()\n      Out[46]:\n      ['AgentBackkup_2015-06-11',\n      '.viminfo',\n      '.bash_logout',\n      '.bash_history',\n      'AgentBackup',\n      'rdsAgent']\n    ```\n\nsftp提供了很多命令，具体内容可以参考[官方文档](https://paramiko-docs.readthedocs.org/en/1.15/api/sftp.html) 。",[[1534424278034,["Administrator@Tielemao",[[1,0,"\n"]],[0,0],[1,1]]],[1534424278238,["Administrator@Tielemao",[[1,0,"\n"]],[1,1],[2,2]]],[1534424281199,["Administrator@Tielemao",[[1,0,"# 使用python的paramiko模块实现ssh与scp功能"]],[0,0],[32,32]]],[1534424289350,["Administrator@Tielemao",[[-1,2,"使用"]],[4,4],[2,2]]],[1534424290672,["Administrator@Tielemao",[[-1,8,"的"]],[9,9],[8,8]]],[1534424294070,["Administrator@Tielemao",[[1,8," "]],[8,8],[9,9]]],[1534424300354,["Administrator@Tielemao",[[-1,8," "]],[9,9],[8,8]]],[1534424300793,["Administrator@Tielemao",[[1,8,"et"]],[8,8],[10,10]]],[1534424301902,["Administrator@Tielemao",[[-1,8,"et"]],[10,10],[8,8]]],[1534424302687,["Administrator@Tielemao",[[1,8,"用"]],[8,8],[9,9]]],[1534424306551,["Administrator@Tielemao",[[-1,28,"功能"]],[28,30],[28,28]]],[1534424327777,["Administrator@Tielemao",[[1,31," "]],[31,31],[32,32]]]],null,"Administrator@Tielemao"]]}